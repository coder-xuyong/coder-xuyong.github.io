---
title: ForkJoinæ¡†æ¶
order: 7
categories:
  - 1.Java
  - 1.JavaSE
  - 4.å¹¶å‘
tags:
  - Java
  - JavaSE
  - å¹¶å‘
abbrlink: c16f2ba9
date: 2025-10-18 15:27:46
---

# Java Fork Join æ¡†æ¶

**å¯¹äºç®€å•çš„å¹¶è¡Œä»»åŠ¡ï¼Œä½ å¯ä»¥é€šè¿‡â€œçº¿ç¨‹æ±  +Futureâ€çš„æ–¹æ¡ˆæ¥è§£å†³ï¼›å¦‚æœä»»åŠ¡ä¹‹é—´æœ‰èšåˆå…³ç³»ï¼Œæ— è®ºæ˜¯ AND èšåˆè¿˜æ˜¯ OR èšåˆï¼Œéƒ½å¯ä»¥é€šè¿‡ CompletableFuture æ¥è§£å†³ï¼›è€Œæ‰¹é‡çš„å¹¶è¡Œä»»åŠ¡ï¼Œåˆ™å¯ä»¥é€šè¿‡ CompletionService æ¥è§£å†³ã€‚**

## CompletableFuture

### runAsync å’Œ supplyAsync æ–¹æ³•

CompletableFuture æä¾›äº†å››ä¸ªé™æ€æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚

```java
public static CompletableFuture<Void> runAsync(Runnable runnable)
public static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor)
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier)
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor)
```

æ²¡æœ‰æŒ‡å®š Executor çš„æ–¹æ³•ä¼šä½¿ç”¨ ForkJoinPool.commonPool() ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚å¦‚æœæŒ‡å®šçº¿ç¨‹æ± ï¼Œåˆ™ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± è¿è¡Œã€‚ä»¥ä¸‹æ‰€æœ‰çš„æ–¹æ³•éƒ½ç±»åŒã€‚

- runAsync æ–¹æ³•ä¸æ”¯æŒè¿”å›å€¼ã€‚
- supplyAsync å¯ä»¥æ”¯æŒè¿”å›å€¼ã€‚



## CompletionService

`CompletionService` æ˜¯ Java å¹¶å‘åŒ…ï¼ˆ`java.util.concurrent`ï¼‰ä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦ç”¨äº **æ‰¹é‡æäº¤ä»»åŠ¡åæŒ‰å®Œæˆé¡ºåºè·å–ç»“æœ**ã€‚
å¸¸è§å®ç°ç±»æ˜¯ `ExecutorCompletionService`ã€‚

> âœ… é€‚ç”¨åœºæ™¯ï¼šå½“ä½ æäº¤å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¸Œæœ›**è°å…ˆå®Œæˆå…ˆå¤„ç†è°**ï¼Œè€Œä¸æ˜¯æŒ‰æäº¤é¡ºåºç­‰å¾…ç»“æœã€‚


**ä¸»è¦ç»„æˆ**

`CompletionService` ç»“åˆäº†ä¸¤ä¸ªç»„ä»¶ï¼š

1. **Executor** â€”â€” ç”¨äºæ‰§è¡Œä»»åŠ¡ï¼ˆé€šå¸¸æ˜¯ `ThreadPoolExecutor`ï¼‰ã€‚
2. **BlockingQueue** â€”â€” å­˜æ”¾å·²å®Œæˆä»»åŠ¡çš„ç»“æœï¼Œæ–¹ä¾¿æŒ‰å®Œæˆé¡ºåºè·å–ã€‚


**å¸¸ç”¨æ–¹æ³•**

| æ–¹æ³•                         | ä½œç”¨                        |
| -------------------------- | ------------------------- |
| `submit(Callable<V> task)` | æäº¤ä»»åŠ¡ï¼Œè¿”å›ä¸€ä¸ª `Future`        |
| `take()`                   | é˜»å¡ç­‰å¾…å¹¶è·å–ä¸‹ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡           |
| `poll()`                   | éé˜»å¡åœ°è·å–ä¸‹ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡ï¼ˆå¯èƒ½è¿”å› nullï¼‰ |


### ç®€å•ç¤ºä¾‹

```java
import java.util.concurrent.*;

public class CompletionServiceDemo {
    public static void main(String[] args) throws Exception {
        // 1. åˆ›å»ºçº¿ç¨‹æ± 
        ExecutorService executor = Executors.newFixedThreadPool(3);
        
        // 2. åˆ›å»º CompletionService
        CompletionService<String> completionService = new ExecutorCompletionService<>(executor);
        
        // 3. æäº¤å¤šä¸ªä»»åŠ¡
        for (int i = 1; i <= 5; i++) {
            int taskId = i;
            completionService.submit(() -> {
                // æ¨¡æ‹Ÿä¸åŒä»»åŠ¡è€—æ—¶
                long sleepTime = (long) (Math.random() * 3000);
                Thread.sleep(sleepTime);
                return "ä»»åŠ¡ " + taskId + " å®Œæˆï¼Œè€—æ—¶ " + sleepTime + " ms";
            });
        }
        
        // 4. æŒ‰å®Œæˆé¡ºåºè·å–ç»“æœ
        for (int i = 0; i < 5; i++) {
            Future<String> future = completionService.take(); // é˜»å¡ç›´åˆ°æœ‰ä»»åŠ¡å®Œæˆ
            System.out.println(future.get());
        }
        
        // 5. å…³é—­çº¿ç¨‹æ± 
        executor.shutdown();
    }
}
```

ğŸ§¾ **è¾“å‡ºç¤ºä¾‹ï¼ˆéšæœºé¡ºåºï¼‰ï¼š**

```
ä»»åŠ¡ 3 å®Œæˆï¼Œè€—æ—¶ 420 ms
ä»»åŠ¡ 1 å®Œæˆï¼Œè€—æ—¶ 880 ms
ä»»åŠ¡ 5 å®Œæˆï¼Œè€—æ—¶ 1320 ms
ä»»åŠ¡ 2 å®Œæˆï¼Œè€—æ—¶ 1900 ms
ä»»åŠ¡ 4 å®Œæˆï¼Œè€—æ—¶ 2780 ms
```

---

### ğŸš€æ€»ç»“è¦ç‚¹

* `ExecutorService` æŒ‰æäº¤é¡ºåºå–ç»“æœï¼›
* `CompletionService` æŒ‰å®Œæˆé¡ºåºå–ç»“æœï¼›
* å†…éƒ¨ç”¨ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ä¿å­˜å·²å®Œæˆä»»åŠ¡ï¼›
* å¸¸ç”¨äºæ‰¹é‡çˆ¬è™«ã€æ‰¹é‡è¯·æ±‚ã€æ•°æ®èšåˆç­‰éœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ æŠŠè¿™ä»½ç¬”è®°æ•´ç†æˆ Markdown æ ¼å¼ï¼ˆå¸¦é«˜äº®ä¸å°æ ‡é¢˜ï¼Œæ–¹ä¾¿ä½ ç›´æ¥æ”¾è¿›ç¬”è®°è½¯ä»¶æˆ–åšå®¢ï¼‰ï¼Ÿ

## Fork/Join

**æ¦‚å¿µ**
Fork/Join æ˜¯ JDK 1.7 åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§**åˆ†æ²»æ€æƒ³**ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ cpu å¯†é›†å‹
è¿ç®—ã€‚
æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡
ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ã€éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£ã€‚

Fork/Join åœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿
ç®—æ•ˆç‡

**Fork/Join é»˜è®¤ä¼šåˆ›å»ºä¸ cpu æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± **

**ä½¿ç”¨**
æäº¤ç»™ Fork/Join çº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿ RecursiveTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ– RecursiveActionï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹
é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹ 1~n ä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡
```java
@Slf4j(topic = "c.AddTask")
class AddTask1 extends RecursiveTask < Integer > {

    int n;

    public AddTask1(int n) {
        this.n = n;
    }

    @Override
    public String toString() {
        return "{" + n + '}';
    }

    @Override
    protected Integer compute() {
        // å¦‚æœ n å·²ç»ä¸º 1ï¼Œå¯ä»¥æ±‚å¾—ç»“æœäº†
        if (n == 1) {
            log.debug("join() {}", n);
            return n;
        }

        // å°†ä»»åŠ¡è¿›è¡Œæ‹†åˆ†(fork)
        AddTask1 t1 = new AddTask1(n - 1);
        t1.fork();
        log.debug("fork() {} + {}", n, t1);

        // åˆå¹¶(join)ç»“æœ
        int result = n + t1.join();
        log.debug("join() {} + {} = {}", n, t1, result);
        return result;
    }
}
```

ç„¶åæäº¤ç»™ ForkJoinPool æ¥æ‰§è¡Œ
```java
public static void main(String[] args) {
 ForkJoinPool pool = new ForkJoinPool(4);
 System.out.println(pool.invoke(new AddTask1(5)));
}
```
ç»“æœï¼š
```shell
[ForkJoinPool-1-worker-0] - fork() 2 + {1} 
[ForkJoinPool-1-worker-1] - fork() 5 + {4} 
[ForkJoinPool-1-worker-0] - join() 1 
[ForkJoinPool-1-worker-0] - join() 2 + {1} = 3 
[ForkJoinPool-1-worker-2] - fork() 4 + {3} 
[ForkJoinPool-1-worker-3] - fork() 3 + {2} 
[ForkJoinPool-1-worker-3] - join() 3 + {2} = 6 
[ForkJoinPool-1-worker-2] - join() 4 + {3} = 10 
[ForkJoinPool-1-worker-1] - join() 5 + {4} = 15 
15
```

